22 | DOM树：JavaScript是如何影响DOM树构建的？

### 什么是DOM

- 沿着网络数据流路径DOM树生成

- DOM提供了对HTML文档结构化的表述

- DOM作用

  - DOM是生成页面的数据结构
  - DOM提供JS操作的接口，通过接口可以对DOM进行访问，修改文档结构样式和内容
  - 从安全视角看，不安全内容在DOM解析阶段就被拒绝了

- DOM树生成

  - HTML Parser，将HTML字节流转换为DOM结构(网络进程加载多少数据，html解析器解析多少数据)
  - 网络进程和渲染进程之间会建立一个共享数据的管道(字节流)
  - 字节流转换成DOM三个阶段
    1. 通过分词器将字节流转换为Token(词法分析)(Tag Token, text token)
    2. 第二阶段和第三阶段是同步进行的，将token解析为DOM节点，并将DOM节点添加到DOM树中
    3. HTML parser维护一个Token栈结构，压入一个StartTag Token，解析器为Token创建一个DOM节点，将节点加入DOM Tree中，然后父节点就是栈中相邻的那个元素生成的节点，如果解析到文本Token，就生成一个文本节点，将节点添加到DOM树中，不需要压入栈，分析出EndTag标签，解析器会查看Token栈顶是否是StartTag对应的DOM节点，是就从栈中弹出，然后整个节点解析完成，通过不断出栈入栈直至将字节流全部分词完成。
    4. HTML Parser开始工作时，默认创建一个根为document的空DOM结构，然后不断将字节流中的StartTag标签解析压入Token栈中，剩下EndTag标签解析到也压入栈中同时检查父级Token需不需要出栈(判断当前栈顶元素)

  

  #### JS如何影响DOM生成

  - 在标签中如果遇到内嵌Script标签， 渲染引擎判断这是一段脚本，HTML解析器暂停DOM的解析，因为接下来的JS可能要修改已经生成的DOM结构
  - HTML解析器停止后，JS引擎接入并执行Script中的脚本，执行完之后，HTML解析器恢复解析，继续解析后面内容，最终形成DOM
  - 如果是JS文件加载，虽然执行流程是一样的，但是这个JS脚本需要被下载，其下载过程会阻塞DOM解析，Chrome做了很多优化，其中一个为预解析操作，渲染引擎收到字节流之后，会开启一个预解析线程，用于分析HTML文件中包含的JS，CSS等文件，解析到相关文件后，预解析线程会提前下载这些文件。
  - CDN加速JS加载，压缩JS文件体积可以规避JS线程阻塞DOM的问题，同时如果JS文件中没有操作DOM的相关代码，可以将JS脚本设置为异步加载(async或defer)，标记后的脚本文件中，async标记的一旦加载完成，就立即执行，defer标记的脚本，需要在DOMContentLoaded事件后执行。
  - 如果JS中出现样式控制的DOM操作的话(操控CSSOM)，需要先解析JS中的所有CSS样式，如果引用了外部的CSS文件，在执行JS之前，还得等CSS外部文件下载完成，解析生成完CSSOM对象之后才能执行JS文件。
  - 但是在JS引擎解析JS文件前，不知道是否操作CSSOM，所以在渲染引擎遇到JS脚本前，不管是否操作CSSOM，都会执行CSS文件下载，解析完成在执行JS文件。
  - JS脚本依赖样式表，阻塞过程增加，优化点在下篇文章。

## summary

- DOM生成， 基于DOM生成过程分析JS阻塞DOM生成，CSS和JS都会影响DOM生成，所以可以在下篇文章引入深刻理解优化首次页面渲染(首屏加载)
- 渲染引擎安全检查模块`XSSAuditor`检测词法安全，分词器解析出来token之后，会检测模块是否安全，是否引用外部脚本，是否符合CSP规范，是否存在跨站点请求，如果出现不符合规范内容，检查模块就会对该脚本或者下载任务进行拦截。

- CSS不阻塞dom的生成。
  CSS不阻塞js的加载，但是会阻塞js的执行。
  js会阻塞dom的生成，也就是会阻塞页面的渲染，那么css也有可能会阻塞页面的渲染。